<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2023" />
<meta name="DC.rights.owner" content="(C) Copyright 2023" />
<meta name="generator" content="DITA-OT" /><meta name="DC.type" content="topic" />
<meta name="DC.title" content="PIC32CX-BZ3 Standalone Bootloader Component Help" />
<meta name="DC.relation" scheme="URI" content="GUID-F9698DC6-BF78-4773-A5E3-CA7D4F570394.html" />
<meta name="DC.relation" scheme="URI" content="GUID-80611E1C-ADA6-450A-B484-9B67D8C6BCFE.html" />
<meta name="DC.relation" scheme="URI" content="GUID-3D686B12-9733-42ED-A3A8-8418CBB8CFA2.html" />
<meta name="DC.relation" scheme="URI" content="GUID-9914BAEF-0E8A-43F0-A610-212D102107A6.html" />
<meta name="DC.relation" scheme="URI" content="GUID-317A5E50-6A52-4E41-AD29-F92236737621.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F" />
<meta name="DC.language" content="en-US" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<title>PIC32CX-BZ3 Standalone Bootloader Component Help</title>
<meta name="Microsoft.Help.Id" content="GUID-2085FE66-A762-4CC0-B054-7F98E8AF999A-GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F" />
<meta name="Microsoft.Help.TocParent" content="GUID-2085FE66-A762-4CC0-B054-7F98E8AF999A-GUID-F9698DC6-BF78-4773-A5E3-CA7D4F570394" />
<meta name="Microsoft.Help.TocOrder" content="0" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="MPLAB Harmony PIC32CX-BZ System Services Reference 4 10/2023" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
         
         function copyContent(content, button) {
         
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                     button.textContent = "Copy";
                     button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
               console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
         }
         
         function cpy(id, button) {
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            
            copyContent(content, button);
         }
         
         document.addEventListener("DOMContentLoaded", function(event) {
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.style.position = "relative";
               var copy = document.createElement("button");
               copy.textContent = "Copy";
               copy.setAttribute("class", "copy-code");
               
               var content = elem.textContent;
               
               copy.addEventListener("click", function(){
                  copyContent(content, copy);
               });
               
               elem.addEventListener("mouseenter", function(evt){
                  elem.prepend(copy);
               });
            });
            
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.addEventListener("mouseleave", function(evt){
                  document.querySelector(".copy-code").remove();
               });
            });
         });
         
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /></head>
<body id="GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F">

<h1 class="title topictitle1" id="GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F__GUID-D9A86BED-B81C-42D8-8657-24BE47C108E3" style="">PIC32CX-BZ3 Standalone Bootloader Component
    Help</h1>
<div class="body">
                <p class="p">PIC32CX-BZ3 bootloader is a standalone harmony component, Using it, one can
      generate bootloader which is a program that typically is loaded in to the boot flash memory
      and gets executed every time the device powers up or resets. Due to the size of the internal
      flash, PIC32CX-BZ3 bootloader supports external flash. The external flash that is supported in
      this component is SST26 (available on WBZ351 curiosity board) </p>

                <p class="p">Bootloader can be used to upgrade firmware on a target device without the need
                        for an external programmer or debugger. It does not fully operate on the
                        device, but can perform various functions prior to starting the main
                        application</p>

                <div class="p"><strong class="ph b"><u class="ph u">Functionality of Bootloader</u></strong><ul class="ul" id="GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F__UL_JBR_HX3_JZB">
        <li class="li" id="GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F__GUID-BEA6458F-2F31-46AA-8184-D3606C4AFA7F">Loads firmware images to embedded flash/external flash over the serial connection using
          a tool or python script, known as Device Firmware Upgrade (DFU)</li>

        <li class="li" id="GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F__GUID-1C9C974B-3F9D-4DFF-B6FA-75F24FEA6AAB">Provides application protection for firmware (Secured device)</li>

        <li class="li" id="GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F__GUID-C05FA656-D2AB-4D57-A2F6-C5607A644FAE">Upgrades application firmware to newer revision</li>

        <li class="li" id="GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F__GUID-B03F2B1F-8198-4A88-8B87-0800E635016D">Controls which application can run based on Sequence number and other metadata
          information embedded in the OTA image.</li>

      </ul>
</div>

                <p class="p"><strong class="ph b"><u class="ph u">Memory Information and Layout of PIC32CXBZ3 device (WBZ351 Curiosity
          Board)</u></strong>
    </p>

                <div class="p">
                        
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F__TABLE_JYW_GYY_HSB" class="table" frame="border" border="1" rules="all"><caption><span class="tablecap"><span class="table--title-label">Table 1. </span></span></caption>
                                        <col style="width:50%" />
                                        <col style="width:50%" />
                                        <thead class="thead" style="text-align:left;">
                                                <tr class="row">
                                                  <th class="entry cellrowborder" style="vertical-align:middle;" id="d62713e63"><span>Memory Area</span></th>

                                                  <th class="entry cellrowborder" style="vertical-align:middle;" id="d62713e66"><span>Purpose</span></th>

                                                </tr>

                                        </thead>

                                        <tbody class="tbody">
                                                <tr class="row">
                                                  <td class="entry cellrowborder" style="vertical-align:middle;" headers="d62713e63 "><span>Boot Flash Size is 0x0080_0000 to
                0x0080_3FFF  (16KB)</span></td>

                                                  <td class="entry cellrowborder" style="vertical-align:middle;" headers="d62713e66 "><span>The memory where  bootloader code
                                                  runs</span></td>

                                                </tr>

                                                <tr class="row">
                                                  <td class="entry cellrowborder" style="vertical-align:middle;" headers="d62713e63 "><span>Embeded Flash Slot 0 base address -
                0x01000000</span></td>

                                                  <td class="entry cellrowborder" style="vertical-align:middle;" headers="d62713e66 "><span>The memory where the application firmware
                                                  runs and the memory where the bootloader copies
                                                  the new application firmware </span></td>

                                                </tr>

                                                <tr class="row">
                                                  <td class="entry cellrowborder" style="vertical-align:middle;" headers="d62713e63 "><span>Embedded Flash Slot 1 base address -
                0x01040000</span></td>

                                                  <td class="entry cellrowborder" style="vertical-align:middle;" headers="d62713e66 "><span>The memory where the received image(Either
                                                  through DFU or any other way) gets stored. and the
                                                  memory where bootloader looks for the new image to
                                                  copy into the Slot 0</span></td>

                                                </tr>

            <tr class="row">
              <td class="entry cellrowborder" style="vertical-align:middle;" headers="d62713e63 "><span>External Flash Slot 0 (SST26)</span></td>

              <td class="entry cellrowborder" style="vertical-align:middle;" headers="d62713e66 "><span>Start Address (relative):0x00000; Size 512KB</span></td>

            </tr>

            <tr class="row">
              <td class="entry cellrowborder" style="vertical-align:middle;" headers="d62713e63 "><span>External Flash Slot 1(SST26)</span></td>

              <td class="entry cellrowborder" style="vertical-align:middle;" headers="d62713e66 "><span>Start Address (relative): 0x80000; Size 512KB</span></td>

            </tr>

                                        </tbody>

                                </table>
</div>

                </div>

                <p class="p"><strong class="ph b"><u class="ph u">Boot Flash</u></strong></p>

                <p class="p">In PIC32CXBZ3, 16KB boot flash memory is separated from the main execution
      memory. This boot flash is used for bootloader code</p>

                <p class="p"><strong class="ph b"><u class="ph u">Metadata Header</u></strong></p>

                <p class="p">Format of image meta-data header is described in the Secure Boot ROM Help page -
        <a class="xref" href="GUID-04D7627E-7290-429B-88B9-2EFFFA11A3A8.html">PIC32CX-BZ3 Secure Boot ROM Help</a>
    </p>

                <p class="p"><u class="ph u"><strong class="ph b">Working of Bootloader</strong></u></p>

                <p class="p">when the application receives new image from a server or via a tool, it
      will/should store in the Slot 1 location with meta data header &amp; firmware or in the
      external flash and it should trigger software reset so that bootloader code runs</p>

                <div class="p">Bootloader checks for valid image in the external flash and the internal flash by
      reading the meta data header and firmware and authenticating the same with the selected
      authentication method. If valid image is found and successfully authenticated, then <ul class="ul" id="GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F__UL_YGN_2QK_XSB">
        <li class="li" id="GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F__GUID-362B3526-AAD1-4355-8F6A-B96E72FD09DA">Erases Slot 0</li>

        <li class="li" id="GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F__GUID-EA6D5CA3-55ED-4696-9AC7-B5FFEEBC52D9">Copies the new image (DFU or OTA) image
          to Slot 0</li>

        <li class="li" id="GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F__GUID-46819B28-AEA1-4839-A457-72BBA2040587">Verifies the Copy</li>

      </ul>
After that it checks for valid image in Slot 0 by validating it, it jumps to the
      application if valid image is found</div>

                <p class="p"><u class="ph u"><strong class="ph b">Bootloader usage with DFU</strong></u></p>

                <p class="p">Bootloader programmed to the MCU (in DFU mode) receives an application image from
      the host over serial interface and writes it to the external flash or internal flash slot 1 .
      After loading new image on external flash or  internal flash slot 1, if reset is triggered,
      then bootloader erases the slot 0, copies the image to slot 0, verifies the copy. Then
      bootloader jumps to application which is the new application image</p>

                <p class="p">Bootloader stores information about the image in Meta Data Header. This is
                        basically size of 0x200 bytes and gets stored at the start of slot.
                        Bootloader reads this meta data header and does the authentication procedure
                        based on the information in meta data header</p>

                <p class="p"><strong class="ph b"><u class="ph u">Flow Diagram of Bootloader</u></strong></p>

                <p class="p">The detailed flow diagram of bootloader with the optional DFU block can be found
                        below</p>

                <p class="p"><img class="image" id="GUID-5E76E081-070E-46EA-86A9-EE08F3F1481F__IMAGE_RC2_VZ1_3SB" src="GUID-4F6F866C-B279-4888-BE8B-E5C1DF40C5E7-low.png" /></p>

        </div>

<div class="related-links">
<ul class="ullinks">
<li class="link ulchildlink"><strong><a href="GUID-80611E1C-ADA6-450A-B484-9B67D8C6BCFE.html">Configuration Options</a></strong><br />
</li>
<li class="link ulchildlink"><strong><a href="GUID-3D686B12-9733-42ED-A3A8-8418CBB8CFA2.html">DFU Functionality - Serial image bootloader</a></strong><br />
</li>
<li class="link ulchildlink"><strong><a href="GUID-9914BAEF-0E8A-43F0-A610-212D102107A6.html">Bootloader API Usage</a></strong><br />
</li>
<li class="link ulchildlink"><strong><a href="GUID-317A5E50-6A52-4E41-AD29-F92236737621.html">DFU API Usage</a></strong><br />
</li>
</ul>

<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-F9698DC6-BF78-4773-A5E3-CA7D4F570394.html">PIC32CX-BZ3 System Services</a></div>
</div>
</div></body>
</html>